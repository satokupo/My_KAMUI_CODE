# Claude Code プロジェクト設定

## メディア生成・処理ワークフロー

### 生成処理
- 画像・動画・音声・3Dなど。生成完了したら必ずローカルに自動保存すること。
- デフォルトのアスペクト比は4:3にすること
- 生成する画像タイトルは`{01からのナンバリング}_{title}_{使用したAIモデル名}`とすること
- タイトル内の変数の中では半角英数字と`-`ハイフン記号のみ許可する

#### 複数生成時の逐次保存フロー
- 複数枚の画像生成は「一括生成/一括ダウンロード」を行わず、必ず逐次（直列）で処理する。
- 各画像について以下を1枚ごとに完了させてから次の生成に進む。
  1. 画像を1枚生成
  2. 直ちにローカルへ保存（保存場所・命名規則は本書のルールに従う）
  3. 保存確認（ファイル存在・サイズ>0・画像として読み込み可能の3条件）
  4. 確認NGの場合は保存処理の再試行を行う（最大3回、1s→2s→4sのバックオフ）
  5. 再試行でも保存できない場合は、Pythonの一時ファイルを用いた保存処理に切り替える（ユーザールールに従う）
- 上記が完了したら次の1枚の生成に着手する。

### 保存処理
#### 保存場所の優先順位
1. **最優先**: ユーザーがチャットで明確に指示した場所
2. **2番目**: 提供された指示書・要件定義書内に記載された保存場所
3. **3番目**: 提供された指示書・要件定義書と同じ階層
4. **最後**: プロジェクトルート（S:/MyProjects/KAMUI_CODE/）

#### 保存時の処理
- 保存したファイルの場所は~からのフルパスで表示
- 必ず得られた認証済URLのフルパスを利用（googleからの場合長い、falの場合は短い）。省略などしない

#### 保存後の検証と再試行
- 全画像の生成が完了した段階で、期待枚数と保存済み枚数を照合し、保存漏れ（欠損）を検出する。
- 欠損がある場合は、保存処理のみを再試行する（可能な限り前回生成結果のキャッシュ/一時ファイルを用いる）。
- 再試行は最大3回実施し、各回でバックオフ（1s→2s→4s）を行う。
- 再試行後も保存に失敗した場合は、エラーログを出力し、対象ファイルを一覧化して手動対応のフラグを残す。

### アップロード処理
#### FAL URLアップロード
**必須**: ファイルをFAL URLに変換する際は`_KAMUI/helper/fal_upload_helper.py`を利用すること

##### 使用方法
```bash
# ファイルをFAL URLに変換 (ファイルパス: S:/MyProjects/KAMUI_CODE/_KAMUI/helper/fal_upload_helper.py)
python _KAMUI/helper/fal_upload_helper.py [ファイルパス] 

# または実行権限付きで直接実行
./_KAMUI/helper/fal_upload_helper.py [ファイルパス]

# MCP連携用 (ファイルパス: S:/MyProjects/KAMUI_CODE/_KAMUI/helper/local_fal_upload.py)
python _KAMUI/helper/local_fal_upload.py [ファイルパス]

# 例：動画ファイルをアップロード 
python _KAMUI/helper/fal_upload_helper.py ./video.mp4 

# 例：画像ファイルをアップロード 
python _KAMUI/helper/fal_upload_helper.py ./image.jpg
```

##### 適用場面
- 動画生成API（Luma, Runway等）へのインプット 
- 画像生成APIへのインプット 
- 音声生成APIへのインプット 
- その他のFAL APIサービス利用時 

**重要**: 手動でのファイルアップロードやURL変換は行わず、必ず上記スクリプトを使用する

##### URL利用時の注意点
- i2v, i2iの際のインプットurlはgoogleからのものを使う。省略の無いように（**ファイルパスではない！**）

## 要件定義・ドキュメント作成

### ビジュアライズ要件定義
- `requirement-docs` の作成場所は資料の要件定義と同じ階層に作成する（ユーザーから明確な指示があればそれに従う）
- 元になる資料が存在しない場合は、プロジェクトルートに作成する
- `requirement-docs` 内に自動生成時に `.git` ディレクトリが作られる場合がある → gitリポジトリからの pull 完了後に `.git` を `.git-archived` にリネームし、親リポジトリ（KAMUI_CODE）配下で一元管理できるようにする

## 基本設定

### 文字コード
- 指示がない限りUTF-8を利用すること