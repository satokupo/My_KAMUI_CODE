# Claude Code プロジェクト設定

## メディア生成・処理ワークフロー

### 生成処理
- 画像・動画・音声・3Dなど。生成完了したら必ずローカルに自動保存すること。
- デフォルトのアスペクト比は4:3にすること
- 生成する画像タイトルは`{01からのナンバリング}_{title}_{使用したAIモデル名}`とすること
- タイトル内の変数の中では半角英数字と`-`ハイフン記号のみ許可する

#### 複数生成時の逐次保存フロー
- 複数枚の画像生成は「一括生成/一括ダウンロード」を行わず、必ず逐次（直列）で処理する。
- 各画像について以下を1枚ごとに完了させてから次の生成に進む。
  1. 画像を1枚生成
  2. 直ちにローカルへ保存（保存場所・命名規則は本書のルールに従う）
  3. 保存確認（ファイル存在・サイズ>0・画像として読み込み可能の3条件）
  4. 確認NGの場合は保存処理の再試行を行う（最大3回、1s→2s→4sのバックオフ）
  5. 再試行でも保存できない場合は、Pythonの一時ファイルを用いた保存処理に切り替える（ユーザールールに従う）
- 上記が完了したら次の1枚の生成に着手する。

### 保存処理
#### 保存場所の優先順位
1. **最優先**: ユーザーがチャットで明確に指示した場所
2. **2番目**: 提供された指示書・要件定義書内に記載された保存場所
3. **3番目**: 提供された指示書・要件定義書と同じ階層
4. **最後**: プロジェクトルート（S:/MyProjects/KAMUI_CODE/）

#### 保存時の処理
- 保存したファイルの場所は~からのフルパスで表示
- 必ず得られた認証済URLのフルパスを利用（googleからの場合長い、falの場合は短い）。省略などしない

#### 保存後の検証と再試行
- 全画像の生成が完了した段階で、期待枚数と保存済み枚数を照合し、保存漏れ（欠損）を検出する。
- 欠損がある場合は、保存処理のみを再試行する（可能な限り前回生成結果のキャッシュ/一時ファイルを用いる）。
- 再試行は最大3回実施し、各回でバックオフ（1s→2s→4s）を行う。
- 再試行後も保存に失敗した場合は、エラーログを出力し、対象ファイルを一覧化して手動対応のフラグを残す。

### ローカル処理の原則（アップロード不要のケース）
- 対象: 画像のリサイズ・トリミング・回転・形式変換・透過化・背景除去・簡易合成など、ローカル環境のみで完結する処理
- ルール:
  - 指定されたローカル画像はそのままファイルパスで参照する（アップロード/URL変換は行わない）
  - バイナリ/byte列/base64への変換は行わない。PIL/OpenCV等のライブラリにはファイルパスまたは`Path`を渡す
  - 一時ファイルが必要な場合は`_temp`を用い、保存後の検証フロー（存在・サイズ>0・画像として読み込み可）に従う
  - 外部APIに入力が必要な場合に限り、後述の手順でFAL URL化を行う
- 禁止事項:
  - ローカル処理において、画像を一旦メモリ上のバイナリやbase64へ変換してから再保存・再読込する実装
  - 理由: 文字コードやエンコード不一致、サイズ肥大化、不要な失敗要因（変換時例外）を誘発しやすいため
- 実装ガイドライン（例）:
  - 関数の引数は「ファイルパス（str/Path）」を第一候補とする
  - 保存は命名規則に従い別名で行い、保存後の検証を必ず実施する
  - 失敗時は再試行し、最終的にPythonの一時ファイル方式へフォールバック可（本書およびユーザールールに従う）

### アップロード処理
#### FAL URLアップロード
注意: ローカルで完結する処理では本節の手順を使用しない（上記「ローカル処理の原則」を優先）。
**必須**: ファイルをFAL URLに変換する際は`_KAMUI/helper/fal_upload_helper.py`を利用すること

##### 使用方法
```bash
# ファイルをFAL URLに変換 (ファイルパス: S:/MyProjects/KAMUI_CODE/_KAMUI/helper/fal_upload_helper.py)
python _KAMUI/helper/fal_upload_helper.py [ファイルパス] 

# または実行権限付きで直接実行
./_KAMUI/helper/fal_upload_helper.py [ファイルパス]

# MCP連携用 (ファイルパス: S:/MyProjects/KAMUI_CODE/_KAMUI/helper/local_fal_upload.py)
python _KAMUI/helper/local_fal_upload.py [ファイルパス]

# 例：動画ファイルをアップロード 
python _KAMUI/helper/fal_upload_helper.py ./video.mp4 

# 例：画像ファイルをアップロード 
python _KAMUI/helper/fal_upload_helper.py ./image.jpg
```

##### 適用場面
- 動画生成API（Luma, Runway等）へのインプット 
- 画像生成APIへのインプット 
- 音声生成APIへのインプット 
- その他のFAL APIサービス利用時 
- ローカル完結処理では使用しない（アップロード不要）

**重要**: 手動でのファイルアップロードやURL変換は行わず、必ず上記スクリプトを使用する

##### URL利用時の注意点
- i2v, i2iの際のインプットurlはgoogleからのものを使う。省略の無いように（**ファイルパスではない！**）

### Pythonヘルパーの配置・運用ポリシー
- **配置場所**: ファイルアップロード・圧縮・変換・入出力などのファイル操作用Pythonヘルパーは、必ず`_KAMUI/helper`に配置・集約すること
- **既存ヘルパーの優先利用**: 新規実装の前に、同ディレクトリの既存スクリプトを参照・再利用すること（例: `fal_upload_helper.py`, `compress_videos.py`）
- **新規作成時のルール**:
  - 原則としてヘルパーは`_KAMUI/helper`直下に作成すること
  - ヘルパーを新規作成・改修した場合、その都度ユーザーに「このファイルを永続化するか／一時利用後に削除するか」を確認すること
  - 便利で再利用価値が高いと判断される場合は、永続化の選択肢を積極的に提案すること
- **一時ファイルの取り扱い**: 保存やアップロード等で通常フローが失敗した場合は、Pythonの一時ファイルでのフォールバックを許可する。ただし有用と判断される場合は、後日`_KAMUI/helper`配下の正式ヘルパーとして格上げすることを提案する
- **ドキュメント整備**: 作成したヘルパーには冒頭コメントで目的・入出力・依存関係・使用例（CLI実行例を含む）を簡潔に記載すること

## 要件定義・ドキュメント作成

### ビジュアライズ要件定義
- `requirement-docs` の作成場所は資料の要件定義と同じ階層に作成する（ユーザーから明確な指示があればそれに従う）
- 元になる資料が存在しない場合は、プロジェクトルートに作成する
- `requirement-docs` 内に自動生成時に `.git` ディレクトリが作られる場合がある → gitリポジトリからの pull 完了後に `.git` を `.git-archived` にリネームし、親リポジトリ（KAMUI_CODE）配下で一元管理できるようにする

## 基本設定

### 文字コード
- 指示がない限りUTF-8を利用すること

### Python環境設定
- このプロジェクトではPython仮想環境（venv）を使用している
- ClaudeCodeCLI経由でPythonスクリプトを実行する際は、必ずvenv環境のPythonを明示的に指定すること
- **必須**: Python実行時は `S:/MyProjects/KAMUI_CODE/.venv/Scripts/python.exe` を使用する
- システムのpython（`python`コマンド）ではなく、venv環境のpythonを使用することで、必要なライブラリ（pillow-heif等）が正しく読み込まれる
- ClaudeCodeは必要に応じて自動的にvenv環境を起動・使用するが、明示的なパス指定により確実性を担保する

#### 実行例
```bash
# 正しい実行方法（venv環境のPythonを明示）
S:/MyProjects/KAMUI_CODE/.venv/Scripts/python.exe _KAMUI/helper/script_name.py

# 間違った実行方法（システムのPythonを使用してしまう）
python _KAMUI/helper/script_name.py
```